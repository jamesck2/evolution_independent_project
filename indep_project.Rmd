---
title: "Indep_project"
author: "Aaron Blue and James Kosmopoulos"
output: html_document
---

## load required packages

```{r packages}
library(tidyverse) ## reshaping spreadsheets
library(lme4) ## linear mixed models
library(car) ## Anova function
```


## load data

```{r load_data}
metadata <- read.csv("./metadata.csv")
```


## summarize data

This might help us plot our data

```{r}
metadata.long <- gather(metadata, key = "trait", value = "value", nodnum, meannodweight, chloro, shootmass)

plants.sum <- metadata.long %>% group_by(trait, plantspori, year, fert) %>% summarize(count = n(),
            mean = mean(value, na.rm = TRUE), 
            SE = sd(value, na.rm = TRUE)/sqrt(count))

strains.sum <- metadata.long %>% group_by(trait, strain, year, fert) %>% summarize(count = n(),
            mean = mean(value, na.rm = TRUE), 
            SE = sd(value, na.rm = TRUE)/sqrt(count))
```



## reaction norms

We've run into an issue here. It looks like we can't make the same comparisons for every reaction norm we wanted to make in our powerpoint. I don't think we can compare nodule traits by year for each rhizobium strain because 2008 and 2018 do not share any of the same strains. I also don't think we can compare plant traits by year for each plant species for the same reason, only one plant species was used in 2018 whereas three were used in 2008.

# Nodnum

```{r}
## by year
    # can't do! none of the strains in 2008 are the same as the strains in 2018
(plot.nodnum.year <- ggplot(data = strains.sum %>% filter(trait=="nodnum"), aes(x=year, y=mean, group=strain, color=strain)) +
   geom_point(size=3, position = position_dodge(0.3)) +
   geom_line(position = position_dodge(0.3)) +
   xlab("Year") +
   ylab("Nodule number") +
   theme_bw() +
   theme(legend.position = "none")
  )

## by environment
(plot.nodnum.env <- ggplot(data = strains.sum %>% filter(trait=="nodnum"), aes(x=fert, y=mean, group=strain, color=strain)) +
   geom_point(size=3, position = position_dodge(0.3)) +
   geom_line(position = position_dodge(0.3)) +
   xlab("Environment") +
   ylab("Nodule number") +
   theme_bw() +
   theme(legend.position = "none")
  )


```

# Nodmass

```{r}
## by year
  # can't do! none of the strains in 2008 are the same as the strains in 2018
(plot.nodmass.year <- ggplot(data = strains.sum %>% filter(trait=="meannodweight"), aes(x=year, y=mean, group=strain, color=strain)) +
   geom_point(size=3, position = position_dodge(0.3)) +
   geom_line(position = position_dodge(0.3)) +
   xlab("Year") +
   ylab("Nodule mass") +
   theme_bw() +
   theme(legend.position = "none")
  )

## by environment
(plot.nodmass.env <- ggplot(data = strains.sum %>% filter(trait=="meannodweight"), aes(x=fert, y=mean, group=strain, color=strain)) +
   geom_point(size=3, position = position_dodge(0.3)) +
   geom_line(position = position_dodge(0.3)) +
   xlab("Environment") +
   ylab("Nodule mass") +
   theme_bw() +
   theme(legend.position = "none")
  )

```

# Chloro

```{r}
## by year
  # can't do! two of three plant species are only in 2008
(plot.chloro.year <- ggplot(data = plants.sum %>% filter(trait=="chloro"), aes(x=year, y=mean, group=plantspori, color=plantspori)) +
   geom_point(size=3, position = position_dodge(0.3)) +
   geom_line(position = position_dodge(0.3)) +
   xlab("Year") +
   ylab("Chlorophyll content") +
   theme_bw()
  )

## by N environment
(plot.chloro.env <- ggplot(data = strains.sum %>% filter(trait=="chloro"), aes(x=fert, y=mean, group=strain, color=strain)) +
   geom_point(size=3, position = position_dodge(0.3)) +
   geom_line(position = position_dodge(0.3)) +
   xlab("Environment") +
   ylab("Chlorophyll content") +
   theme_bw()
  )

```

# Shoot mass

```{r}
## by year
  # can't do! two of three plant species are only in 2008
(plot.shootmass.year <- ggplot(data = plants.sum %>% filter(trait=="shootmass"), aes(x=year, y=mean, group=plantspori, color=plantspori)) +
   geom_point(size=3, position = position_dodge(0.3)) +
   geom_line(position = position_dodge(0.3)) +
   xlab("Year") +
   ylab("Shoot biomass") +
   theme_bw()
  )

## by N environment
(plot.shootmass.env <- ggplot(data = strains.sum %>% filter(trait=="shootmass"), aes(x=fert, y=mean, group=strain, color=strain)) +
   geom_point(size=3, position = position_dodge(0.3)) +
   geom_line(position = position_dodge(0.3)) +
   xlab("Environment") +
   ylab("Shoot biomass") +
   theme_bw()
  )
```




## Random effects models
I made these based off of the models in lab 3. We might have to change them or our original hypotheses because we still can't compare plant genotypes or rhizobium genotypes across different years for the same reason as above. But we can compare genotypes across envirionments.

## Plant shoot biomass models

```{r}
# test if shoot biomass is normally distributed, p<0.05 means data is not normally distributed and we must transform our data with sqrt or log
shapiro.test(metadata$shootmass) # p<0.05, transform data

```


# Shoot mass heritability by year

```{r}
# 2008
# full model with all random effects
lmm_shoot_2008 <- lmer(sqrt(shootmass) ~ plantspori + (1|harvester) + (1|field) + (1|plot) + (1|plant_age), data = metadata %>% filter(year=="2008"))

# model without plot as a random effect
lmm_shoot_2008_dplot <- lmer(sqrt(shootmass) ~ plantspori + (1|harvester) + (1|field) + (1|plant_age), data = metadata %>% filter(year=="2008"))

# model comparison
comp_shoot_2008 <- anova(lmm_shoot_2008, lmm_shoot_2008_dplot)
var_shoot_2008 <- VarCorr(lmm_shoot_2008)

# test results
chi_shoot_2008 <- comp_shoot_2008$Chisq
Df_shoot_2008 <- comp_shoot_2008$Df
sig_shoot_2008 <- (comp_shoot_2008$`Pr(>Chisq)`)/2

# heritability
Var_shoot_2008 <- as.data.frame(var_shoot_2008)
Var_shoot_2008 <- Var_shoot_2008 %>%
  mutate(VP = sum(vcov),
         prop = vcov/VP)

VG_shoot_2008 <- Var_shoot_2008[2,7]

# combine stats and heritability
comb_shoot_2008 <- cbind(chi_shoot_2008[2], Df_shoot_2008[2], sig_shoot_2008[2], VG_shoot_2008)
colnames(comb_shoot_2008) <- c("Chisq", "Df", "p-value", "broad-sense-herit")


# 2018
# full model with all random effects
lmm_shoot_2018 <- lmer(sqrt(shootmass) ~ plantspori + (1|harvester) + (1|field) + (1|plot) + (1|plant_age), data = metadata %>% filter(year=="2018"))

# model without plot as a random effect
lmm_shoot_2018_dplot <- lmer(sqrt(shootmass) ~ plantspori + (1|harvester) + (1|field) + (1|plant_age), data = metadata %>% filter(year=="2018"))

# model comparison
comp_shoot_2018 <- anova(lmm_shoot_2018, lmm_shoot_2018_dplot)
var_shoot_2018 <- VarCorr(lmm_shoot_2018)

# test results
chi_shoot_2018 <- comp_shoot_2018$Chisq
Df_shoot_2018 <- comp_shoot_2018$Df
sig_shoot_2018 <- (comp_shoot_2018$`Pr(>Chisq)`)/2

# heritability
Var_shoot_2018 <- as.data.frame(var_shoot_2018)
Var_shoot_2018 <- Var_shoot_2018 %>%
  mutate(VP = sum(vcov),
         prop = vcov/VP)

VG_shoot_2018 <- Var_shoot_2018[2,7]

# combine stats and heritability
comb_shoot_2018 <- cbind(chi_shoot_2018[2], Df_shoot_2018[2], sig_shoot_2018[2], VG_shoot_2018)
colnames(comb_shoot_2018) <- c("Chisq", "Df", "p-value", "broad-sense-herit")

```

# Shoot mass heritability by N environment

```{r}
# 0N
# full model with all random effects
lmm_shoot_0N <- lmer(sqrt(shootmass) ~ plantspori + (1|harvester) + (1|field) + (1|plot) + (1|plant_age), data = metadata %>% filter(fert=="0 N"))

# model without plot as a random effect
lmm_shoot_0N_dplot <- lmer(sqrt(shootmass) ~ plantspori + (1|harvester) + (1|field) + (1|plant_age), data = metadata %>% filter(fert=="0 N"))

# model comparison
comp_shoot_0N <- anova(lmm_shoot_0N, lmm_shoot_0N_dplot)
var_shoot_0N <- VarCorr(lmm_shoot_0N)

# test results
chi_shoot_0N <- comp_shoot_0N$Chisq
Df_shoot_0N <- comp_shoot_0N$Df
sig_shoot_0N <- (comp_shoot_0N$`Pr(>Chisq)`)/2

# heritability
Var_shoot_0N <- as.data.frame(var_shoot_0N)
Var_shoot_0N <- Var_shoot_0N %>%
  mutate(VP = sum(vcov),
         prop = vcov/VP)

VG_shoot_0N <- Var_shoot_0N[2,7]

# combine stats and heritability
comb_shoot_0N <- cbind(chi_shoot_0N[2], Df_shoot_0N[2], sig_shoot_0N[2], VG_shoot_0N)
colnames(comb_shoot_0N) <- c("Chisq", "Df", "p-value", "broad-sense-herit")


# N-fertilized
# full model with all random effects
lmm_shoot_fertilized <- lmer(sqrt(shootmass) ~ plantspori + (1|harvester) + (1|field) + (1|plot) + (1|plant_age), data = metadata %>% filter(fert=="Fertilized"))

# model without plot as a random effect
lmm_shoot_fertilized_dplot <- lmer(sqrt(shootmass) ~ plantspori + (1|harvester) + (1|field) + (1|plant_age), data = metadata %>% filter(fert=="Fertilized"))

# model comparison
comp_shoot_fertilized <- anova(lmm_shoot_fertilized, lmm_shoot_fertilized_dplot)
var_shoot_fertilized <- VarCorr(lmm_shoot_fertilized)

# test results
chi_shoot_fertilized <- comp_shoot_fertilized$Chisq
Df_shoot_fertilized <- comp_shoot_fertilized$Df
sig_shoot_fertilized <- (comp_shoot_fertilized$`Pr(>Chisq)`)/2

# heritability
Var_shoot_fertilized <- as.data.frame(var_shoot_fertilized)
Var_shoot_fertilized <- Var_shoot_fertilized %>%
  mutate(VP = sum(vcov),
         prop = vcov/VP)

VG_shoot_fertilized <- Var_shoot_fertilized[2,7]

# combine stats and heritability
comb_shoot_fertilized <- cbind(chi_shoot_fertilized[2], Df_shoot_fertilized[2], sig_shoot_fertilized[2], VG_shoot_fertilized)
colnames(comb_shoot_fertilized) <- c("Chisq", "Df", "p-value", "broad-sense-herit")
```



## Plant chlorophyll models

```{r}
# test if shoot biomass is normally distributed
shapiro.test(metadata$chloro) # p<0.05, transform data

```


# Chloro heritability by year

```{r}

```


# Chloro heritability by N environment

```{r}

```



## Rhizobium nodnum models

```{r}
# test if shoot biomass is normally distributed
shapiro.test(metadata$nodnum) # p<0.05, transform data
```


# Nodnum heritability by year

```{r}

```

# Nodnum heritability by N environment

```{r}

```



## Rhizobium nodmass models

```{r}
# test if shoot biomass is normally distributed
shapiro.test(metadata$meannodweight) # p<0.05, transform data
```


# Nodmass heritabiltiy by year

```{r}

```


# Nodmass heritability by N environment

```{r}

```




__