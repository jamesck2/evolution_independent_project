---
title: "Indep_project"
author: "Aaron Blue and James Kosmopoulos"
output: html_document
---

## load required packages

```{r packages}
library(tidyverse) ## reshaping spreadsheets
library(lme4) ## linear mixed models
library(car) ## Anova function
```

## load data

```{r load_data}
metadata <- read.csv("./metadata.csv")
```

## summarize data
This might help us plot our data

```{r}
metadata.long <- gather(metadata, key = "trait", value = "value", nodnum, meannodweight, chloro, shootmass)

plants.sum <- metadata.long %>% group_by(trait, plantspori, year, fert) %>% summarize(count = n(),
            mean = mean(value, na.rm = TRUE), 
            SE = sd(value, na.rm = TRUE)/sqrt(count))

strains.sum <- metadata.long %>% group_by(trait, strain, year, fert) %>% summarize(count = n(),
            mean = mean(value, na.rm = TRUE), 
            SE = sd(value, na.rm = TRUE)/sqrt(count))
```


## reaction norms
We've run into an issue here. It looks like we can't make the same comparisons for every reaction norm we wanted to make in our powerpoint. I don't think we can compare nodule traits by year for each rhizobium strain because 2008 and 2018 do not share any of the same strains. I also don't think we can compare plant traits by year for each plant species for the same reason, only one plant species was used in 2018 whereas three were used in 2008.

```{r}
## number of nodules
## by year
    # can't do! none of the strains in 2008 are the same as the strains in 2018
(plot.nodnum.year <- ggplot(data = strains.sum %>% filter(trait=="nodnum"), aes(x=year, y=mean, group=strain, color=strain)) +
   geom_point(size=3, position = position_dodge(0.3)) +
   geom_line(position = position_dodge(0.3)) +
   xlab("Year") +
   ylab("Nodule number") +
   theme_bw() +
   theme(legend.position = "none")
  )

## by environment
(plot.nodnum.env <- ggplot(data = strains.sum %>% filter(trait=="nodnum"), aes(x=fert, y=mean, group=strain, color=strain)) +
   geom_point(size=3, position = position_dodge(0.3)) +
   geom_line(position = position_dodge(0.3)) +
   xlab("Environment") +
   ylab("Nodule number") +
   theme_bw() +
   theme(legend.position = "none")
  )

## nodule mass
## by year
  # can't do! none of the strains in 2008 are the same as the strains in 2018
(plot.nodmass.year <- ggplot(data = strains.sum %>% filter(trait=="meannodweight"), aes(x=year, y=mean, group=strain, color=strain)) +
   geom_point(size=3, position = position_dodge(0.3)) +
   geom_line(position = position_dodge(0.3)) +
   xlab("Year") +
   ylab("Nodule mass") +
   theme_bw() +
   theme(legend.position = "none")
  )

## by environment
(plot.nodmass.env <- ggplot(data = strains.sum %>% filter(trait=="meannodweight"), aes(x=fert, y=mean, group=strain, color=strain)) +
   geom_point(size=3, position = position_dodge(0.3)) +
   geom_line(position = position_dodge(0.3)) +
   xlab("Environment") +
   ylab("Nodule mass") +
   theme_bw() +
   theme(legend.position = "none")
  )


## chloro
## by year
  # can't do! two of three plant species are only in 2008
(plot.chloro.year <- ggplot(data = plants.sum %>% filter(trait=="chloro"), aes(x=year, y=mean, group=plantspori, color=plantspori)) +
   geom_point(size=3, position = position_dodge(0.3)) +
   geom_line(position = position_dodge(0.3)) +
   xlab("Year") +
   ylab("Chlorophyll content") +
   theme_bw()
  )


```

## Models
I made these based off of the models in lab 2, but I don't think these are the models we need. I'm keeping them for now to help with formatting our other models that we do need, which we can probably use the next chunk below this one to make.

```{r}
## model for shootmass
lmm_shoot <- lmer(log(shootmass) ~ plantspori + fert + year +
                    (1|harvester:field:plot:plant_age), ## random effect
                  data = metadata)
Anova(lmm_shoot, type = 2) # significant for fertilization environment only

## model for chlorophyll
lmm_chloro <- lmer(chloro ~ plantspori + fert + year +
                    (1|harvester:field:plot:plant_age),
                  data = metadata)
Anova(lmm_chloro, type = 2) # significant for fertilization environment only

## model for nodule number
lmm_nodnum <- lmer(nodnum ~ plantspori + fert + year +
                    (1|harvester:field:plot:plant_age),
                  data = metadata)
Anova(lmm_nodnum, type = 2) # significant for fertilization environment and year

## model for nodule mass
lmm_nodmass <- lmer(meannodweight ~ plantspori + fert + year +
                    (1|harvester:field:plot:plant_age),
                  data = metadata)
Anova(lmm_nodmass, type = 2) # significant for fertilization environment and year

```

Random effects model(s)

```{r herit}
#GH
# full model, heritability in the greenhouse
lm_GH <-lmer(sqrt(nod) ~ (1|line) + (1|position) + block, data = raw_data %>% filter(env == "GH"))
lm_GH_dline <- lmer(sqrt(nod) ~ (1|position) + block, data = raw_data %>% filter(env == "GH"))

# model comparison
comp <- anova(lm_GH, lm_GH_dline)
var_GH <- VarCorr(lm_GH)

# test results
chi_GH <- comp$Chisq
Df_GH <- comp$Df
sig_GH <- (comp$`Pr(>Chisq)`)/2

# heritability
Var_GH <- as.data.frame(var_GH)
Var_GH <- Var_GH %>%
  mutate(VP = sum(vcov),
         prop = vcov/VP)

VG_GH <- Var_GH[2,7]

# combine stats and heritability
comb_GH <- cbind(chi_GH[2], Df_GH[2], sig_GH[2], VG_GH)
colnames(comb_GH) <- c("Chisq", "Df", "p-value", "herit")


#Plot 1
# full model, heritability in plot1
lm_plot_1 <-lmer(sqrt(nod) ~ (1|line) + (1|diss) + block, data = raw_data %>% filter(env == "plot_1"))
lm_plot_1_dline <- lmer(sqrt(nod) ~ (1|diss) + block, data = raw_data %>% filter(env == "plot_1"))

# model comparison
comp <- anova(lm_plot_1, lm_plot_1_dline)
var_plot_1 <- VarCorr(lm_plot_1)

# test results
chi_plot_1 <- comp$Chisq
Df_plot_1 <- comp$Df
sig_plot_1 <- (comp$`Pr(>Chisq)`)/2

# heritability
Var_plot_1 <- as.data.frame(var_plot_1)
Var_plot_1 <- Var_plot_1 %>%
  mutate(VP = sum(vcov),
         prop = vcov/VP)

VG_plot_1 <- Var_plot_1[2,7]

# combine stats and heritability
comb_plot_1 <- cbind(chi_plot_1[2], Df_plot_1[2], sig_plot_1[2], VG_plot_1)
colnames(comb_plot_1) <- c("Chisq", "Df", "p-value", "herit")


#Plot 2
# full model, heritability in plot1
lm_plot_2 <-lmer(sqrt(nod) ~ (1|line) + (1|diss) + block, data = raw_data %>% filter(env == "plot_2"))
lm_plot_2_dline <- lmer(sqrt(nod) ~ (1|diss) + block, data = raw_data %>% filter(env == "plot_2"))

# model comparison
comp <- anova(lm_plot_2, lm_plot_2_dline)
var_plot_2 <- VarCorr(lm_plot_2)

# test results
chi_plot_2 <- comp$Chisq
Df_plot_2 <- comp$Df
sig_plot_2 <- (comp$`Pr(>Chisq)`)/2

# heritability
Var_plot_2 <- as.data.frame(var_plot_2)
Var_plot_2 <- Var_plot_2 %>%
  mutate(VP = sum(vcov),
         prop = vcov/VP)

VG_plot_2 <- Var_plot_2[2,7]

# combine stats and heritability
comb_plot_2 <- cbind(chi_plot_2[2], Df_plot_2[2], sig_plot_2[2], VG_plot_2)
colnames(comb_plot_2) <- c("Chisq", "Df", "p-value", "herit")
```

